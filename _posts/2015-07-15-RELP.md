---
layout: post
title: RELP: 可靠的事件日志协议
comments: true
category: 技术
tags: [syslog,rsyslog.日志协议]
---

原文地址[http://www.rsyslog.com/doc/relp.html](http://www.rsyslog.com/doc/relp.html)

这是一篇可靠事件日志协议（the reliable event logging protocol）的规范，简称RELP。

##RELP协议描述

Relp使用一种几乎固定角色的C/S模型。连接的起始部分称为客户端，监听部分为服务器端。在下面的状态图中，C代表Client，S代表Server。

Relp采用命令-响应模式（command-response），客户端发起命令，服务器端响应命令。为了便于全双工通信，多个命令可以同时发出，同时响应，服务器响应不保证顺序。为了节省资源，并发处理的命令数量由窗口机制加以限制。每条命令分配有一个（相对）唯一、单调递增的ID（称为"transaction number" 或简称txn），每个响应带上其对应的命令ID。

这种通信模型有一个潜在的问题：服务器只能响应客户端，而不能主动发起命令。在正常情况下没问题，然而如果服务器down机，将无法通知客户端；当客户端长时间无命令，服务器会话超时也会导致这个问题。一个显而易见的解决办法就是服务器在发送完所有响应时，直接关闭链接，客户端会在再次发送命令之前接到通知。一个更好的办法是，使得服务器可以直接发送命令给客户端。比如保留一个特定的txn（比如0）用于服务器发送的命令。相反，客户端不能响应这些命令，否则协议会变得异常复杂。这种命令其实是“暗示”，他们暗示客户端（不是命令），丢失“暗示”并不致命。最终关闭TCP链接来关闭会话。

##错误处理

如果出现问题（比如无效帧），检测到问题的一端将关闭底层TCP连接。它可以发送一个error/abort“暗示”，但不等待回应。这是因为当今Internet的不友好，试图优雅地解决通信问题可能导致攻击。“终止出错的连接既安全又合理有效”。

##发送消息

“消息”是命令的一种，对应的响应是“ACK/NAK”。因此每条消息都必须确认收到，RELP配置确认的“深度”。极端情况下，服务器在消息处理完成（比如成功写入数据库）时才发送确认。不过当前实现中采用应用级别的确认，即只保证服务器收到消息。

##REPL帧

所有的REPL 事务（命令）包裹在一个确定的帧中：

```python

RELP-FRAME = HEADER DATA TRAILER
DATA = [SP 1*OCTET] ; command-defined data, if DATALEN is 0, no data is present
HEADER = TXNR SP COMMAND SP DATALEN
TXNR = NUMBER ; relp transaction number, monotonically increases, starts at 1
DATALEN = NUMBER
#old:COMMAND = "open" / "syslog" / "close" / "rsp" / "abort" ; max length = 32
COMMAND = 1*32ALPHA
TRAILER = LF ; to detect framing errors and enhance human readibility
ALPHA = letter ; ('a'..'z', 'A'..'Z')
NUMBER = 1*9DIGIT
DIGIT = %d48-57
LF = %d10
SP = %d32

RSP DATA CONTENT:
RSP-HEADER = TXNR SP RSP-CODE [SP HUMANMSG] LF [CMDDATA]
RSP-CODE = 200 / 500 ; 200 is ok, all the rest currently erros
HUAMANMSG = *OCTET ; a human-readble message without LF in it
CMDDATA = *OCTET ; semantics depend on original command
TXNR is as in the relp frame, it is the TXNR of the frame being responded to.
```

即：

----------------------------------------------------
|TXNR   | |Command  | |Datalen  | |Data         |LF|
----------------------------------------------------

----------------------------------------------------
|TXNR   | |Res Code | | 





